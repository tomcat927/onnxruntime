# .github/workflows/build-musllinux.yml
name: Build onnxruntime musllinux aarch64 wheel

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-wheel:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout onnxruntime
        uses: actions/checkout@v4
        with:
          repository: microsoft/onnxruntime
          ref: ${{ github.ref_name }}

      - name: Set up QEMU for aarch64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and extract wheel using inline Dockerfile
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          VERSION="${VERSION:-1.20.0}"
          docker buildx build --progress=plain \
            --platform linux/arm64 \
            --build-arg ONNXRUNTIME_VERSION=$VERSION \
            --output type=local,dest=wheelhouse \
            - << 'EOF'
            # syntax=docker/dockerfile:1
            FROM --platform=linux/arm64 alpine:3.18
            ARG ONNXRUNTIME_VERSION=1.20.0
            RUN apk add --no-cache python3 py3-pip g++ make linux-headers cmake wget tar openssl-dev libffi-dev
            RUN pip3 install --upgrade pip
            RUN pip3 install --no-cache-dir numpy protobuf setuptools wheel
            WORKDIR /workspace
            COPY . .
            RUN ./build.sh --config Release --build_shared_lib --parallel --skip_tests --use_openmp
            RUN cd python && python3 setup.py bdist_wheel --dist-dir ../wheelhouse
            CMD ["sh", "-c", "cp /workspace/wheelhouse/*.whl /local/ || echo 'No wheel built'"]
            EOF

      - name: Upload wheel
        uses: actions/upload-artifact@v4  # ✅ 已更新为 v4
        with:
          path: wheelhouse/
          if-no-files-found: error  # 如果没生成 wheel，报错
